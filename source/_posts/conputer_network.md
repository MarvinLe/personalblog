---
title: 计算机网络分层
date: 2018-11-06 14:03
comments: true
top: true
tags:
- 网络分层
- 计网
categories:
- 计算机基础
---

## 分层思想  

> “Any problem  in computer science can be solved by anther layer of indirection.“

”计算机科学领域的任何问题都可以通过增加一个中间层来解决“  

这句话几乎概括了计算机系统软件的设计要点-分层。分层不仅可以将系统的复杂度分解到不同的层去以降低复杂
度,而且可以解耦系统，每一层的实现相互独立，层与层之间通过接口通信。

平时我们开发应用程序是使用语言的Runtime、类库,类库的实现基本上依赖于操作系统的系统调用，而系统调用就
是我们和内核通信的接口。

OS是这样，计算机网络分层就更加明显了。

## 网络协议分层

> 每一次回车qq消息是怎么发给对方的呢？我们都知道这要依靠互联网，而互联网的实现是分层的，用户能够
> 只会感觉到他的消息通过qq发送到了对方qq里，而不会去关注中途ip包怎么路由、丢包怎么办这样底层的
> 问题，这就是分层的好处。分层方式一般有五层模型和OSI七层模型。

### 五层模型

在五层模型里，每一层都定义了不同的多种协议(protocol)，协议规定了该层需要完成的功能以及如何数据
怎么封装。这些协议就组成了TCP/IP协议栈，学习计网就是学习这些协议为什么要这样制定？它解决了什么问
题？有什么缺陷？而不是仅仅去记住封装包的格式和字段含义。

![](https://ws3.sinaimg.cn/large/006tNbRwly1fwzm90dh3yj31920qoai3.jpg)

自底向上的学习互联网协议我觉得更为合适，明白了底层再学习上一层心里就会特别的清晰、踏实。

#### 物理层:

1. 两台主机要通信，最终肯定是要相互连接起来的，连接就需要一些传输信号的介质，常见的有屏蔽/非屏蔽
双绞线、光纤、无线电波等。而物理层的协议就是主要规定一些与传输介质相关的电气特性。所有的数据在这
一层都没有意义，就是单纯的高低电频这样代表0、1的信号

1.  常用的术语:
    * 信号
    * 码元
    * 单工、半双工、全双工
    * 奈式准则、香农法则
    * 基带信号
    * 带通
    * 比特率
    * 波特率
    * 信道复用、信道分用

#### 链接层:

物理层上传送的单个0和1没有任何意义，必须将bit位分组，并规定多少个bit为一组，分组在以太网就叫做
帧(Frame)，一个帧包括头部(Head)和数据(Data)，Head是存放一些数据包的源地址和目的地址还有一些
标志位。Data是存放来自上层协议的数据，一个以太网基本帧64-1518个字节，头部一般为18个字节，所以
数据区一般不超过1500个字节，这也叫做MTU(最大传输单元)。但是这不是绝对的，有不同版本的以太网帧

![基本以太网帧](https://ws3.sinaimg.cn/large/006tNbRwly1fwzn6hmohvj30ct01sq32.jpg)
  
上图中的目标地址和源地址指的就是MAC地址,有了MAC地址路由器、交换机就知道把数据传给谁了。

> MAC地址：每一个接入网络的设备都有至少一个网卡，网卡上固化有MAC地址，这是每块网卡出厂的时候被
> 固化到上面硬件上的一个独一无二的42个bit的编码，有了这个地址就能知道该把包发给谁了。

那么有了地址之后系统又是怎么把数据发送给对方的呢？  

早期主机之间组网的拓扑图有很多种:
![](https://ws1.sinaimg.cn/large/006tNbRwgy1fx0k6itge4j30mw0eegnn.jpg)

而以太网采用的是总线拓扑结构，这种结构的特点就是任意两台主机之间的通信由于共用总线所以其它主机也能收到数据包。正是由于这样的特点，以太网就是采用将数据包封装上目的mac地址和源mac地址，直接发向整个网络，每个主机都能接受到数据包，然后判断目的mac地址是否是自己，是就接受，不是就不做处理，这样的方式就叫做“广播”，很明显这样的网络是不安全的，任何人都能接受到同一个广播域的数据包，就可能发生一些信息窃取，中间人攻击等。所以发展到后面出现了网桥、交换机这种可以自学习的包转发设备，你发往交换机的数据包，交换机会根据目的MAC地址做定向转发。

这样通过mac地址和广播我们就能把数据发到同一个子网的任何主机了。这里其实还有一个问题，那就是我们怎么知道其它主机的MAC地址，这就涉及到ARP协议了，ARP就是实现IP地址到MAC地址的转换的，这个协议可以说是整个互联网协议栈中最简单、最不安的，常见的网络攻击比如中间人劫持、网络扫描、流量欺骗等都和ARP脱不了干系。

#### 网络层:
 
以太网是通过MAC地址和广播通信的，但是由于我们不可能把世界上所有主机都连接在一个子网，况且就算可以，任何主机发一个数据包都是广播到全网，这将是巨大的灾难。正是这样，我们需要把不同地域的主机连接到一个子网，不同子网再相互连接，这样就组成了网络的网络。这样又导致一个问题，不同子网主机如何知道对方的MAC地址呢？因为MAC地址是扁平化分布的，比如我们出去旅游笔记本连当地网络，但是我们MAC地址还是不变的，这样网络核心设备根本无法确定这个MAC地址的主机到底处在哪个子网，意味着我们无法以MAC地址来路由。

于是网络层诞生了，它引入一个逻辑上的地址，使得我们可以通过这个地址区分不同主机是否在一个子网。这就是“网址”即IP。IP地址是层级的，是与地域分布相关的就好像现实世界中的地址。

举个例子,假如现在我们要给四川大学的A同学(四川大学A同学就相当于IP地址)写一封信，我们需要把它地址和姓名填上然后把信交给快递公司(网络核心设备)，快递公司知道应该先给四川(一个大规模的子网)分公司，然后四川分公司知道要给成都(一个中规模等的子网)分公司，这样继续下去直到川大快递点。
这里我们做个假设: **快递公司必须知道我们的身份证号(MAC地址)才能把快递发给我们。**那么快递公司怎么知道A同学的身份证号呢？很简单，可以通过在校园内发一个广播(谁是A同学，请告诉我你的身份号)，这样如果A同学听到了他就可以把他的身份证号发给快递点，而其它同学听到了但不是自己也就不会做任何回复。这样我们就实现了信件(数据包)的发送，当然现实中快递点知道我们电话号码不会这么傻的全校广播。但是这就是网络中随时会发生的事。

上面例子中快递点通过广播将川大A同学(IP地址)和身份证号(MAC地址)做转化的过程就是ARP协议。当一个子网内的B主机要和A主机通信且不知道对方MAC地址时，就需要向子网发送广播(谁是A，请告诉我你的MAC地址)，A收到后就会回复(我是A，我的MAC地址是xxxa)。正常情况下其它主机是不会回复的，但是偏偏有些人不老实，比如C它向B回复（我是A，我的MAC地址是xxxc)，这就是ARP攻击，具体的还是单独写一篇分析吧。

这里我们看到我们通过IP地址，以及ARP协议就实现了跨子网主机之间的通信。

#### 传输层:  

网络层将不同主机之间连接起来，但是主机上的不用应用程序的不同进程需要通信，就需要  
支持主机间多个进程的通信。故采用多路复用的方法建立端到端(port)的通信。  

#### 应用层: 
定义应用程序之间如何交互信息

* 公开的协议如HTTP、SMTP等
* 自定义私有协议  


### OSI七层模型

未完。
